<html lang="en">

<head>
    <!--Please make sure to use the latest and greatest version of each project! -->
    <!--I just downloaded these for extra reliabilty: https://codepen.io/blikblum/pen/gJNWMg -->
    <script src="./standalone_dependencies/pdfkit.standalone.js"></script>
    <script src="./standalone_dependencies/blob-stream.js"></script>
    <script src="./standalone_dependencies/md5.js"></script>
    <script src="./Invoice.js"></script>
</head>

<body>
    <h1>Test out <a href="https://github.com/snakysnake/invoice-js" target="_blank">Invoice.js</a></h1>
    <h2>Invoice.js - Open source invoice Class to PDF for JavaScript</h2>

    <flex>
        <form onsubmit="event.preventDefault(); setSeller();">
            <h3>Set your business info</h3>
            <div class="formRow">

                <label for="sellerBusiness">Name:</label>
                <input type="text" id="sellerBusiness" name="sellerBusiness">
                <label for="sellerAddy">Address:</label>
                <input type="text" id="sellerAddy" name="sellerAddy">
                <label for="sellerZip">Zip:</label>
                <input type="text" id="sellerZip" name="sellerZip">
                <label for="sellerCity">City:</label>
                <input type="text" id="sellerCity" name="sellerCity">
                <label for="sellerCountry">Country:</label>
                <input type="text" id="sellerCountry" name="sellerCountry">
            </div>
                <button type="submit">Set business info</button>
        </form>
        <form onsubmit="event.preventDefault(); setBuyer();">
            <h3>Client Info</h3>
            <div class="formRow">
            <label for="buyerBusiness">Name:</label>
            <input type="text" id="buyerBusiness" name="buyerBusiness">
            <label for="buyerAddy">Address:</label>
            <input type="text" id="buyerAddy" name="buyerAddy">
            <label for="buyerZip">Zip:</label>
            <input type="text" id="buyerZip" name="buyerZip">
            <label for="buyerCity">City:</label>
            <input type="text" id="buyerCity" name="buyerCity">
            <label for="buyerCountry">Country:</label>
            <input type="text" id="buyerCountry" name="buyerCountry">
            </div>
            <button type="submit">Set client info</button>
        </form>
        <form onsubmit="event.preventDefault(); setPaymentInfo();">
            <h3>Payment Info</h3>
            <div class="formRow">
            <label for="paymentName">Name:</label>
            <input type="text" id="paymentName" name="paymentName">
            <label for="bankName">Bank Name:</label>
            <input type="text" id="bankName" name="bankName">
            <label for="iban">IBAN:</label>
            <input type="text" id="iban" name="iban">
            <label for="bic">BIC:</label>
            <input type="text" id="bic" name="bic">
        </div>
            <button type="submit">Set payment info</button>
        </form>
        <form onsubmit="event.preventDefault(); setInvoiceInfo();">
            <h3>Invoice Info</h3>
            <div class="formRow">
            
            <label for="vatId">VAT-ID:</label>
            <input type="text" value="MYVATID" id="vatId" name="vatId">
            <label for="invoiceDate">Date:</label>
            <input type="date" id="invoiceDate" name="invoiceDate">
            <label for="dueDate">Due Date:</label>
            <input type="date" id="dueDate" name="dueDate">
            <label for="lang">Language:</label>
            <select name="lang" id="lang">
                <option value="de">German</option>
                <option value="en">English</option>
            </select>
            <label for="currency">Currency:</label>
            <input type="text" id="currency" name="currency" value="usd">
            </div>
            <button type="submit">Set invoice info</button>
        </form>
        <form onsubmit="event.preventDefault(); addProduct();">
            <h3>Add Product</h3>
            <div class="formRow">

            <label for="prodName">Name:</label>
            <input type="text" id="prodName" name="prodName">
            <label for="prodNetPrice">Net price:</label>
            <input type="number" id="prodNetPrice" name="prodNetPrice">
            <label for="prodVat">Vat (in %):</label>
            <input type="number" id="prodVat" name="prodVat">
            </div>
            <button type="submit">Add product</button>
        </form>
        <div>
            <h3>View Products</h3>
            <p>Click a product to remove it</p>
            <div id="productContainer"></div>
        </div>
    </flex>
    <iframe id="pdf_iframe" width="95vw" height="auto"></iframe>
</body>

</html>

<script>
    let invoice;

    // my business
    let businessName = "My Business";
    let businessAddy = "Mainstreet 1";
    let businessZip = "1010";
    let businessCity = "Vienna";
    let businessCountry = "Austria";

    // client business
    let cBusinessName = "Client Business";
    let cBusinessAddy = "Offroad 1";
    let cBusinessZip = "1220";
    let cBusinessCity = "Vienna";
    let cBusinessCountry = "Austria";

    // invoice info
    let invoiceId = "TestInvoiceNr1"
    let invoiceDate = new Date();
    let invoiceDueDate = new Date();
    let vatId = "MYVATID";
    let locale = "en";
    let currency = "usd";

    // payment info
    let bankName;
    let ownerName;
    let iban;
    let bic;

    // product (example)
    let products = [
        {
            id: md5("Invoice.JS"),
            name: "Invoice.JS",
            netPrice: 0,
            vat: 0,
            grossPrice: 0
        }
    ];

    document.addEventListener('DOMContentLoaded', function (event) {
        updatePDF();
    });

    function setSeller() {
        businessName = document.getElementById("sellerBusiness").value;
        businessAddy = document.getElementById("sellerAddy").value;
        businessZip = document.getElementById("sellerZip").value;
        businessCity = document.getElementById("sellerCity").value;
        businessCountry = document.getElementById("sellerCountry").value;

        updatePDF();
    }

    function setBuyer() {
        businessName = document.getElementById("buyerBusiness").value;
        businessAddy = document.getElementById("buyerAddy").value;
        businessZip = document.getElementById("buyerZip").value;
        businessCity = document.getElementById("buyerCity").value;
        businessCountry = document.getElementById("buyerCountry").value;

        updatePDF();
    }

    function setPaymentInfo() {
        ownerName = document.getElementById("paymentName").value;
        bankName = document.getElementById("bankName").value;
        iban = document.getElementById("iban").value;
        bic = document.getElementById("bic").value;

        updatePDF();
    }

    function setInvoiceInfo() {
        vatId = document.getElementById("vatId").value;
        invoiceDate = new Date(document.getElementById("invoiceDate").value);
        invoiceDueDate = new Date(document.getElementById("dueDate").value);
        locale = document.getElementById("lang").value;
        currency = document.getElementById("currency").value;

        updatePDF();
    }

    function removeProduct(id) {
        console.log("Removing");
        products.splice(products.findIndex(function (i) {
            return i.id === id;
        }), 1);

        showProductsHTML();
    }

    function addProduct() {
        let name = document.getElementById("prodName").value;
        let netPrice = Number(document.getElementById("prodNetPrice").value);
        let vat = Number(document.getElementById("prodVat").value);
        let grossPrice = netPrice * (1 + vat / 100);
        let id = md5(Math.random());

        products.push({ id: id, name: name, netPrice: netPrice, vat: vat, grossPrice: grossPrice });

        showProductsHTML();
    }

    function showProductsHTML() {
        const container = document.getElementById("productContainer");
        container.innerHTML = "";

        products.forEach((product) => {
            const pElement = document.createElement("div");
            console.log(product);
            pElement.innerText = `${product.name} (${product.grossPrice})`;
            pElement.setAttribute("onclick", `removeProduct('${product.id}')`);
            pElement.setAttribute("class", "redonhover");
            container.appendChild(pElement);
        });

        updatePDF();
    }

    async function updatePDF() {
        invoice = new Invoice(invoiceId, invoiceDate, invoiceDueDate, vatId, locale);
        invoice.setSeller(businessName, businessAddy, businessZip, businessCity, businessCountry);
        invoice.setBuyer(cBusinessName, cBusinessAddy, cBusinessZip, cBusinessCity, cBusinessCountry);
        invoice.setCurrency(currency);

        products.forEach((product) => {
            invoice.addProduct(product.name, product.netPrice, product.vat, product.grossPrice);
        });

        invoice.setPaymentInfo(iban, ownerName, bic, bankName);

        const pdf = await invoice.generatePDF(); // base 64 format

        document.getElementById("pdf_iframe").setAttribute("src", `data:application/pdf;base64,${pdf}`);
    }
</script>

<style>

    #productContainer {
        font-weight: 800;
    }

    .formRow {
        display: flex;
        flex-direction: row;

        flex-wrap: wrap;
    
    }


    .formRow > * {
        margin: 1rem 1rem 1rem 0rem;
    }
    form {
        background-color: #d1d5db;
        padding: 0rem 2rem 0rem 2rem;
        flex-wrap: wrap;
        width: 80vw;
    }

    body {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    #pdf_iframe {
        width: calc(95vw - 18px) !important;
        height: auto;
        aspect-ratio: 8.5/11;
    }

    flex {
        display: flex;
        flex-wrap: wrap;
        flex-direction: column;
        align-items: center;
    }



    button {
        margin-top: 10px;
        margin-bottom: 10px;
        font-size: large;
        padding: 5px;
    }

    label {
        font-weight: bold;
    }

    h3 {
        text-decoration: underline;
    }

    .redonhover:hover {
        color: red;
        cursor: pointer;
    }
</style>
